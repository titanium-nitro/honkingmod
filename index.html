<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HonkingMod</title>
<style>
:root{--bg:#87ceeb;--panel:#ffe680;--accent:#ff9900;--danger:#ff0033;--border:#333;--muted:#444;}
html,body{margin:0;height:100%;font-family:Tahoma,Arial,sans-serif;background:var(--bg);}
.app{max-width:1100px;margin:0 auto;padding:12px;display:grid;grid-template-columns:280px 1fr;gap:12px;}
.card{background:var(--panel);border:3px solid var(--border);padding:10px;border-radius:6px;box-shadow:4px 4px 0 #000;}
h1,h2{margin:6px 0;font-weight:bold;color:#000;text-shadow:1px 1px #fff;}
label{display:block;margin-top:6px;font-size:13px;font-weight:bold;}
input[type=text],input[type=password]{width:100%;padding:6px;border-radius:4px;border:2px inset #ccc;background:#fff;color:#000;font-size:13px;}
button{cursor:pointer;padding:6px 10px;border-radius:4px;border:2px outset #999;background:var(--accent);color:#fff;font-weight:bold;box-shadow:2px 2px 0 #000;}
button:active{border:2px inset #999;box-shadow:none;}
.muted{color:var(--muted);font-size:12px;}
.users-list{max-height:260px;overflow:auto;margin-top:10px;}
.user-item{display:flex;align-items:center;gap:8px;padding:6px;background:#fff;border:2px solid #000;margin:4px 0;}
.avatar{width:32px;height:32px;border:2px solid #000;border-radius:4px;background:#ffcc00;display:flex;align-items:center;justify-content:center;font-weight:bold;}
.main{display:flex;flex-direction:column;gap:12px;}
.topbar{display:flex;justify-content:space-between;align-items:center;background:#ffcc66;border:3px solid #000;}
.world{height:400px;border:3px solid #000;border-radius:6px;display:flex;overflow:hidden;background:#c0ffc0;}
.canvas{flex:1;background:#99ddff;display:flex;flex-direction:column;}
.chat{width:280px;border-left:3px solid #000;display:flex;flex-direction:column;background:#fffbe6;}
.messages{flex:1;padding:8px;overflow:auto;font-size:13px;}
.msg{margin-bottom:6px;border-bottom:1px dashed #aaa;padding-bottom:4px;}
.composer{display:flex;padding:6px;gap:6px;background:#ffeb99;border-top:3px solid #000;}
.composer input{flex:1;}
.danger{background:var(--danger)!important;}
footer{margin-top:12px;text-align:center;font-size:12px;color:#000;}
@media(max-width:900px){.app{grid-template-columns:1fr;}.world{height:300px;flex-direction:column;}.chat{width:100%;border-left:none;border-top:3px solid #000;}}
</style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>HonkingMod Accounts</h1>

      <!-- auth-area will be rendered into this -->
      <div id="auth-area" aria-live="polite"></div>

      <div id="account-controls" style="display:none;margin-top:12px">
        <div style="background:#fff;padding:6px;border:2px solid #000;margin-bottom:6px">Logged in as <strong id="me-name"></strong></div>
        <label>Display name</label>
        <input id="display-name" type="text" />
        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
          <button id="save-profile">Save</button>
          <button id="logout">Logout</button>
          <button id="delete-account" class="danger">Delete</button>
        </div>
      </div>

      <hr style="margin:10px 0;border:2px dashed #000">
      <h2>Users</h2>
      <div class="muted">Accounts and chat are stored online.</div>
      <div class="users-list" id="users-list"></div>
    </div>

    <div class="main">
      <div class="card topbar">
        <div><h1>HonkingMod World</h1><div class="muted">Scratch + 2008 Roblox style</div></div>
        <div class="muted">Current: <span id="top-current">(none)</span></div>
      </div>

      <div class="world">
        <div class="canvas">
          <div style="padding:6px;display:flex;gap:8px;align-items:center;background:#ffeb99;border-bottom:3px solid #000">
            <div class="avatar" id="canvas-avatar">ðŸ™‚</div>
            <div><div id="canvas-name">Guest</div><div class="muted">Click HONK!</div></div>
          </div>
          <div style="padding:12px;flex:1">
            <button id="honkhonk" disabled>HONK!</button>
            <p class="muted" style="margin-top:6px">Wacky test world.</p>
          </div>
        </div>

        <div class="chat">
          <div style="padding:6px;border-bottom:3px solid #000;background:#ffcc66"><strong>Global Chat</strong></div>
          <div class="messages" id="messages" aria-live="polite"></div>
          <div class="composer">
            <input id="chat-input" type="text" placeholder="Say something..." disabled />
            <button id="send-chat" disabled>Send</button>
          </div>
        </div>
      </div>

      <footer class="card">HonkingMod â€” powered by Firebase. Shared chat/accounts.</footer>
    </div>
  </div>

  <!-- Firebase SDKs (compat for simple code) -->
  <script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-firestore-compat.js"></script>

  <script>
  // ---------- CONFIG (already filled with the values you gave) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyAgsn_BkIWvlenmsAOXaWGfkuGH0H50AiM",
    authDomain: "honkingmod.firebaseapp.com",
    projectId: "honkingmod",
    storageBucket: "honkingmod.appspot.com",
    messagingSenderId: "484991397323",
    appId: "1:484991397323:web:5b1f72eaa0b6c3d0abcdef"
  };

  // ---------- INIT ----------
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------- DOM helpers ----------
  function $id(id){return document.getElementById(id);}
  function $(sel){return document.querySelector(sel);}
  function escapeHtml(s){return String(s).replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[m]));}

  // ---------- Render auth UI and attach listeners immediately ----------
  function renderAuth(){
    const area = $id('auth-area');
    area.innerHTML = `
      <label>Email</label>
      <input id="auth-email" type="text" placeholder="you@example.com" />
      <label>Password</label>
      <input id="auth-password" type="password" placeholder="password" />
      <div style="margin-top:6px;display:flex;gap:6px">
        <button id="btn-register">Register</button>
        <button id="btn-login">Login</button>
      </div>
      <div id="auth-note" class="muted" style="margin-top:8px">Use an email/password to register. For testing add <strong>localhost</strong> to Firebase Authorized domains.</div>
    `;

    // Register
    $id('btn-register').addEventListener('click', async () => {
      try {
        const email = $id('auth-email').value.trim();
        const pass = $id('auth-password').value;
        if(!email || !pass){ alert('Enter email and password'); return; }
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        // create a user profile doc in Firestore (safe because rules will require auth)
        await db.collection('users').doc(cred.user.uid).set({
          email: email,
          displayName: email,
          createdAt: Date.now()
        });
        alert('Registered â€” you are now logged in.');
      } catch (err) {
        console.error('register error', err);
        alert('Register error: ' + err.message);
      }
    });

    // Login
    $id('btn-login').addEventListener('click', async () => {
      try {
        const email = $id('auth-email').value.trim();
        const pass = $id('auth-password').value;
        if(!email || !pass){ alert('Enter email and password'); return; }
        await auth.signInWithEmailAndPassword(email, pass);
        // onAuthStateChanged handler will run
      } catch (err) {
        console.error('login error', err);
        alert('Login error: ' + err.message);
      }
    });
  }

  // ---------- Auth state handling ----------
  auth.onAuthStateChanged(async (user) => {
    try {
      if(user){
        // show account controls
        $id('auth-area').style.display = 'none';
        $id('account-controls').style.display = 'block';
        $id('me-name').textContent = user.email;
        $id('top-current').textContent = user.email;
        $id('canvas-name').textContent = user.email;
        $id('canvas-avatar').textContent = user.email[0].toUpperCase();

        // populate display name from Firestore if exists
        const doc = await db.collection('users').doc(user.uid).get();
        if(doc.exists){
          const data = doc.data();
          $id('display-name').value = data.displayName || user.email;
        } else {
          $id('display-name').value = user.email;
        }

        // enable chat controls & start listening to messages
        enableChat();
        startMessagesListener();
        renderUsersList();
      } else {
        // not logged in
        $id('auth-area').style.display = 'block';
        $id('account-controls').style.display = 'none';
        $id('me-name').textContent = '';
        $id('top-current').textContent = '(none)';
        $id('canvas-name').textContent = 'Guest';
        $id('canvas-avatar').textContent = 'ðŸ™‚';
        disableChat();
        stopMessagesListener();
        renderUsersList();
      }
    } catch (err) {
      console.error('onAuthStateChanged handler error', err);
    }
  });

  // ---------- Save profile, logout, delete ----------
  $id('save-profile').addEventListener('click', async () => {
    const user = auth.currentUser;
    if(!user) return alert('Not logged in');
    const dn = $id('display-name').value.trim() || user.email;
    try {
      await db.collection('users').doc(user.uid).set({ displayName: dn, email: user.email }, { merge: true });
      alert('Profile saved.');
      $id('canvas-name').textContent = dn;
      renderUsersList();
    } catch (err) {
      console.error('save profile', err);
      alert('Save error: ' + err.message);
    }
  });

  $id('logout').addEventListener('click', ()=>{ auth.signOut().catch(e=>console.error(e)); });

  $id('delete-account').addEventListener('click', async () => {
    const user = auth.currentUser;
    if(!user) return;
    if(!confirm('Delete account and all your profile data? This cannot be undone.')) return;
    try {
      await db.collection('users').doc(user.uid).delete();
      await user.delete(); // may require recent login; may throw
      alert('Account deleted.');
    } catch (err) {
      console.error('delete account', err);
      alert('Delete failed: ' + err.message + ' (you might need to re-login before deleting)');
    }
  });

  // ---------- Users list (simple: current user only) ----------
  function renderUsersList(){
    const list = $id('users-list');
    const user = auth.currentUser;
    if(user){
      list.innerHTML = `<div class="user-item"><div class="avatar">${escapeHtml(user.email[0].toUpperCase())}</div><div><strong>${escapeHtml(user.email)}</strong></div></div>`;
    } else {
      list.innerHTML = `<div class="muted">Not logged in</div>`;
    }
  }

  // ---------- Chat: enable/disable + send ----------
  function enableChat(){
    $id('chat-input').disabled = false;
    $id('send-chat').disabled = false;
    $id('honkhonk').disabled = false;
  }
  function disableChat(){
    $id('chat-input').disabled = true;
    $id('send-chat').disabled = true;
    $id('honkhonk').disabled = true;
  }

  async function sendChat(){
    const text = $id('chat-input').value.trim();
    const user = auth.currentUser;
    if(!user) return alert('Log in first to chat');
    if(!text) return;
    try {
      await db.collection('messages').add({
        author: user.email,
        text: text,
        time: Date.now()
      });
      $id('chat-input').value = '';
    } catch (err) {
      console.error('sendChat', err);
      alert('Send failed: ' + err.message);
    }
  }

  $id('send-chat').addEventListener('click', sendChat);
  $id('chat-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') sendChat(); });
  $id('honkhonk').addEventListener('click', async () => {
    const user = auth.currentUser;
    if(!user) return alert('Log in first to HONK!');
    try {
      await db.collection('messages').add({ author: user.email, text: 'HONK!', time: Date.now() });
    } catch (err) {
      console.error('honkhonk', err);
      alert('Honk failed: ' + err.message);
    }
  });

  // ---------- Messages listener (realtime) ----------
  let messagesUnsub = null;
  function startMessagesListener(){
    if(messagesUnsub) return;
    try {
      messagesUnsub = db.collection('messages').orderBy('time', 'asc').limit(500).onSnapshot(snapshot => {
        const container = $id('messages');
        container.innerHTML = '';
        snapshot.forEach(doc => {
          const m = doc.data();
          const div = document.createElement('div');
          div.className = 'msg';
          const timeText = m.time ? new Date(m.time).toLocaleTimeString() : '';
          div.innerHTML = `<strong>${escapeHtml(m.author||'anon')}</strong>: ${escapeHtml(m.text||'')}<div class="muted">${escapeHtml(timeText)}</div>`;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      }, err => {
        console.error('messages onSnapshot error', err);
      });
    } catch(err){
      console.error('startMessagesListener error', err);
    }
  }
  function stopMessagesListener(){
    if(messagesUnsub){ messagesUnsub(); messagesUnsub = null; }
    $id('messages').innerHTML = '';
  }

  // ---------- Initial render ----------
  // render auth UI immediately (no race). Script is already at bottom of body so DOM exists.
  renderAuth();

  // ---------- NOTES & helpful console hints ----------
  console.info('HonkingMod loaded. For local testing run: python -m http.server 8000  then open http://localhost:8000/HonkingMod.html');
  console.info('If auth fails, ensure "localhost" or your site domain is added under Firebase Console â†’ Authentication â†’ Authorized domains.');
  </script>
</body>
</html>

