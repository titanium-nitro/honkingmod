<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HonkingMod</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
:root{
  --sonic-blue:#0033cc; --knuckles-red:#cc0000; --border:#ffff00; --bg1:#111; --bg2:#222;
}
body{margin:0;font-family:'Press Start 2P',monospace;background:repeating-linear-gradient(45deg,var(--bg1),var(--bg1) 20px,var(--bg2) 20px,var(--bg2) 40px);color:#fff;}
h1{text-align:center;padding:12px;margin:0;font-size:18px;background:linear-gradient(to right,var(--sonic-blue),var(--knuckles-red));-webkit-text-stroke:1px black;}
.container{display:grid;grid-template-columns:250px 1fr 250px;gap:10px;max-width:1200px;margin:0 auto;padding:10px;}
.panel{background:#000;border:4px solid var(--border);padding:8px;border-radius:0;box-shadow:4px 4px 0 #444;}
button{display:block;width:100%;background:var(--sonic-blue);color:#fff;border:4px solid var(--knuckles-red);padding:10px;margin:6px 0;cursor:pointer;font-family:'Press Start 2P',monospace;font-size:10px;text-transform:uppercase;}
button:disabled{background:#555;border-color:#333;cursor:not-allowed;}
input,textarea{width:95%;margin:4px 0;padding:6px;border:3px solid var(--knuckles-red);background:#111;color:#fff;font-family:'Press Start 2P',monospace;font-size:10px;resize:vertical;}
#messages{max-height:250px;overflow-y:auto;background:#111;border:3px solid var(--sonic-blue);padding:4px;font-size:10px;}
.msg{margin:2px 0;}
.user-item{display:flex;align-items:center;font-size:10px;margin:3px 0;cursor:pointer;padding:4px;border:1px solid transparent;}
.user-item:hover{background:#111;border-color:#333;}
.avatar{width:36px;height:36px;background:var(--knuckles-red);display:flex;align-items:center;justify-content:center;margin-right:8px;border:2px solid var(--sonic-blue);font-size:14px;}
#license-card{margin-top:10px;padding:6px;background:#111;border:3px solid var(--sonic-blue);font-size:10px;}
.profile-view{margin-top:10px;padding:8px;background:#080808;border:3px solid var(--sonic-blue);}
.profile-actions{display:flex;gap:6px;margin-top:8px;}
.small{font-size:10px;padding:6px;}
.footer-note{margin-top:8px;font-size:10px;color:#bbb;}
@media(max-width:900px){.container{grid-template-columns:1fr;}.avatar{width:28px;height:28px;font-size:12px;}}
</style>
</head>
<body>
<h1>HonkingMod</h1>

<div class="container">
  <!-- LEFT: Account -->
  <div class="panel">
    <h2>Account</h2>
    <div id="auth-area">
      <input id="reg-nick" placeholder="Nickname"><br>
      <input id="reg-email" placeholder="Email"><br>
      <input id="reg-pass" type="password" placeholder="Password"><br>
      <button id="btn-register">Register</button>
      <hr>
      <input id="log-email" placeholder="Email"><br>
      <input id="log-pass" type="password" placeholder="Password"><br>
      <button id="btn-login">Login</button>
      <button id="btn-logout">Logout</button>
    </div>
    <div id="me-name" class="small"></div>
    <div id="license-card" style="display:none;"></div>
    <div class="footer-note">Your email is private; nickname is public.</div>
  </div>

  <!-- CENTER: Canvas & Games -->
  <div class="panel">
    <h2>Canvas</h2>
    <div style="display:flex;align-items:center;">
      <div class="avatar" id="canvas-avatar">ðŸ™‚</div>
      <div id="canvas-name">Guest</div>
    </div>
    <p>Current user: <span id="top-current">(none)</span></p>
    <button id="honkhonk" disabled>HONK!</button>

    <h2>Games</h2>
    <button id="btn-smk" disabled>Play Super Mario Kart</button>
    <button id="btn-s3ak" disabled>Play Sonic 3 & Knuckles</button>
    <button id="btn-terraria" disabled>Play Terraria</button>

    <!-- itch.io iframe for Minecraft (hidden until login) -->
    <div id="mc-iframe-container" style="display:none;margin-top:8px;">
      <iframe frameborder="0" src="https://itch.io/embed/3915950?bg_color=000000&amp;fg_color=ffffff&amp;link_color=cdffb4&amp;border_color=000000" width="552" height="167">
        <a href="https://titanium-nitro.itch.io/minecraft-honking-mod-edition-v06">Minecraft Honking Mod Edition: Classic v0.6 by Nitro</a>
      </iframe>
    </div>
  </div>

  <!-- RIGHT: Users & Chat -->
  <div class="panel">
    <h2>Users</h2>
    <div id="users-list" style="max-height:180px;overflow:auto;"></div>
    <h2>Chat</h2>
    <div id="messages"></div>
    <input id="chat-input" placeholder="Type message..." disabled>
    <button id="send-chat" disabled>Send</button>
  </div>
</div>

<!-- PROFILE VIEW (below everything) -->
<div class="panel" id="profile-panel" style="max-width:1200px;margin:10px auto;display:none;">
  <div id="profile-content" class="profile-view">
    <!-- Populated by JS -->
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
// ----------------- CONFIG -----------------
const firebaseConfig = {
  apiKey: "AIzaSyAgsn_BkIWvlenmsAOXaWGfkuGH0H50AiM",
  authDomain: "honkingmod.firebaseapp.com",
  projectId: "honkingmod",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ----------------- HELPERS -----------------
const $id = id => document.getElementById(id);
function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[m])); }
function generateLicense(){ return "HM-" + Math.random().toString(36).substr(2,6).toUpperCase(); }

// ----------------- AUTH / REG -----------------
$id('btn-register').onclick = async () => {
  const nick = $id('reg-nick').value.trim() || 'Anon';
  const email = $id('reg-email').value.trim();
  const pass = $id('reg-pass').value;
  if(!email || !pass) return alert('Enter email and password');
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    const license = generateLicense();
    await db.collection('users').doc(cred.user.uid).set({
      displayName: nick,
      license: license,
      description: '',
      pfpUrl: ''
    });
    alert('Registered as ' + nick + '\\nLicense: ' + license);
  }catch(e){ console.error(e); alert('Register error: '+e.message); }
};

$id('btn-login').onclick = ()=> {
  auth.signInWithEmailAndPassword($id('log-email').value, $id('log-pass').value)
    .catch(e=>{ console.error(e); alert('Login error: '+e.message); });
};
$id('btn-logout').onclick = ()=> auth.signOut();

// ----------------- CHAT & HONK -----------------
$id('send-chat').onclick = async () => {
  const text = $id('chat-input').value.trim();
  if(!text) return;
  const user = auth.currentUser;
  if(!user) return alert('Log in first');
  // store displayName with message to avoid extra lookups later
  const udoc = await db.collection('users').doc(user.uid).get();
  const displayName = (udoc.exists && udoc.data().displayName) ? udoc.data().displayName : 'Anon';
  await db.collection('messages').add({ uid: user.uid, displayName: displayName, text: text, time: Date.now() });
  $id('chat-input').value = '';
};

$id('honkhonk').onclick = async () => {
  const user = auth.currentUser;
  if(!user) return alert('Log in to honk!');
  const udoc = await db.collection('users').doc(user.uid).get();
  const displayName = (udoc.exists && udoc.data().displayName) ? udoc.data().displayName : 'Anon';
  await db.collection('messages').add({ uid: user.uid, displayName: displayName, text: 'HONK!', time: Date.now() });
};

// ----------------- USERS LIST & PROFILE VIEW -----------------
async function renderUsersList(){
  try{
    const snapshot = await db.collection('users').orderBy('displayName').get();
    const list = $id('users-list');
    list.innerHTML = '';
    snapshot.forEach(doc=>{
      const d = doc.data();
      const uid = doc.id;
      const div = document.createElement('div');
      div.className = 'user-item';
      div.innerHTML = '<div class="avatar">'+escapeHtml((d.displayName||' ')[0]||'?')+'</div><div>'+escapeHtml(d.displayName||'Anon')+'</div>';
      div.addEventListener('click', ()=> viewProfile(uid) );
      list.appendChild(div);
    });
  }catch(e){ console.error('renderUsersList', e); }
}

async function viewProfile(uid){
  // fetch document
  try{
    const doc = await db.collection('users').doc(uid).get();
    if(!doc.exists) return alert('Profile not found');
    const data = doc.data();
    const currentUser = auth.currentUser;
    // build profile HTML
    let html = '';
    html += '<div style="display:flex;align-items:center;gap:12px;">';
    html += '<div style="width:72px;height:72px;border:3px solid var(--sonic-blue);background:#111;display:flex;align-items:center;justify-content:center;font-size:26px;">';
    html += (data.pfpUrl ? `<img src="${escapeHtml(data.pfpUrl)}" alt="pfp" style="max-width:68px;max-height:68px;display:block;">` : escapeHtml((data.displayName||' ')[0]||'ðŸ™‚'));
    html += '</div>';
    html += '<div>';
    html += '<div style="font-size:14px">'+escapeHtml(data.displayName||'Anon')+'</div>';
    html += '<div class="small">License: '+escapeHtml(data.license||'N/A')+'</div>';
    html += '<div style="margin-top:6px;">'+(data.description?escapeHtml(data.description):'<span class="small" style="color:#999">No description</span>')+'</div>';
    html += '</div></div>';
    html += '<div style="margin-top:8px;">';
    // If current user is the owner, show edit fields
    if(currentUser && currentUser.uid === uid){
      html += '<hr>';
      html += '<div><label class="small">Edit description</label>';
      html += `<textarea id="edit-desc" rows="3">${escapeHtml(data.description||'')}</textarea></div>`;
      html += '<div><label class="small">Profile picture URL</label>';
      html += `<input id="edit-pfp" placeholder="https://..." value="${escapeHtml(data.pfpUrl||'')}" /></div>`;
      html += '<div class="profile-actions">';
      html += '<button id="save-profile" class="small">Save</button>';
      html += '<button id="close-profile" class="small">Close</button>';
      html += '</div>';
    } else {
      html += '<div style="margin-top:8px;"><button id="close-profile" class="small">Close</button></div>';
    }
    html += '</div>';
    $id('profile-content').innerHTML = html;
    $id('profile-panel').style.display = 'block';
    // attach listeners if owner
    if(currentUser && currentUser.uid === uid){
      $id('save-profile').addEventListener('click', async ()=>{
        const newDesc = $id('edit-desc').value;
        const newPfp = $id('edit-pfp').value.trim();
        try{
          await db.collection('users').doc(uid).set({ description: newDesc, pfpUrl: newPfp }, { merge: true });
          alert('Profile updated');
          // refresh UI
          renderUsersList();
          viewProfile(uid);
          // update canvas if it's the current user
          if(auth.currentUser && auth.currentUser.uid === uid){
            $id('canvas-name').textContent = data.displayName || auth.currentUser.email;
            if(newPfp) $id('canvas-avatar').innerHTML = `<img src="${escapeHtml(newPfp)}" style="max-width:36px;max-height:36px;border-radius:2px;">`;
            else $id('canvas-avatar').textContent = (data.displayName||' ')[0]||'ðŸ™‚';
          }
        }catch(e){ console.error('save-profile', e); alert('Save failed: '+e.message); }
      });
      $id('close-profile').addEventListener('click', ()=> $id('profile-panel').style.display='none');
    } else {
      $id('close-profile').addEventListener('click', ()=> $id('profile-panel').style.display='none');
    }
  }catch(e){ console.error('viewProfile', e); alert('Failed to load profile'); }
}

// ----------------- MESSAGES LISTENER -----------------
let messagesUnsub = null;
function startMessagesListener(){
  if(messagesUnsub) messagesUnsub();
  messagesUnsub = db.collection('messages').orderBy('time').limit(500).onSnapshot(snapshot=>{
    const container = $id('messages');
    container.innerHTML = '';
    snapshot.forEach(doc=>{
      const m = doc.data();
      const div = document.createElement('div');
      div.className = 'msg';
      div.textContent = (m.displayName||'Anon') + ': ' + (m.text||'');
      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
  }, err => { console.error('messages listener', err); });
}

// ----------------- AUTH STATE HANDLING -----------------
auth.onAuthStateChanged(async user=>{
  try{
    if(user){
      // load profile doc
      const doc = await db.collection('users').doc(user.uid).get();
      const data = doc.exists ? doc.data() : {};
      const nickname = data.displayName || 'Anon';
      const license = data.license || 'N/A';
      const pfp = data.pfpUrl || '';
      $id('me-name').textContent = 'Logged in as ' + nickname;
      $id('canvas-name').textContent = nickname;
      if(pfp) {
        $id('canvas-avatar').innerHTML = `<img src="${escapeHtml(pfp)}" style="max-width:36px;max-height:36px;border-radius:2px;">`;
      } else {
        $id('canvas-avatar').textContent = nickname[0].toUpperCase();
      }
      $id('top-current').textContent = nickname;
      $id('license-card').style.display = 'block';
      $id('license-card').innerHTML = 'HonkingMod License<br>' + escapeHtml(license);

      // enable chat/honk/games
      $id('chat-input').disabled = false;
      $id('send-chat').disabled = false;
      $id('honkhonk').disabled = false;
      $id('btn-smk').disabled = false;
      $id('btn-s3ak').disabled = false;
      $id('btn-terraria').disabled = false;
      $id('mc-iframe-container').style.display = 'block';

      // render lists & messages
      renderUsersList();
      startMessagesListener();
    } else {
      // logged out UI
      $id('me-name').textContent = '';
      $id('canvas-name').textContent = 'Guest';
      $id('canvas-avatar').textContent = 'ðŸ™‚';
      $id('top-current').textContent = '(none)';
      $id('license-card').style.display = 'none';
      $id('chat-input').disabled = true;
      $id('send-chat').disabled = true;
      $id('honkhonk').disabled = true;
      $id('btn-smk').disabled = true;
      $id('btn-s3ak').disabled = true;
      $id('btn-terraria').disabled = true;
      $id('mc-iframe-container').style.display = 'none';
      $id('users-list').innerHTML = '';
      $id('messages').innerHTML = '';
      if(messagesUnsub) { messagesUnsub(); messagesUnsub = null; }
      $id('profile-panel').style.display = 'none';
    }
  }catch(e){ console.error('onAuthStateChanged handler', e); }
});

// ----------------- Game buttons (local files) -----------------
$id('btn-smk').onclick = ()=> window.location.href = 'SMK.html';
$id('btn-s3ak').onclick = ()=> window.location.href = 's3ak.html';
$id('btn-terraria').onclick = ()=> window.location.href = 'Terraria.html';

// ----------------- Initial UI state -----------------
$id('chat-input').disabled = true;
$id('send-chat').disabled = true;
$id('honkhonk').disabled = true;
$id('btn-smk').disabled = true;
$id('btn-s3ak').disabled = true;
$id('btn-terraria').disabled = true;

// ----------------- Utility: click user from anywhere ---
// (other parts call viewProfile(uid))
</script>
</body>
</html>

